<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <title>Music Recommendation</title>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
    <main class="mx-auto max-w-3xl px-4 py-10">
        <section class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-200 sm:p-8">
            <header>
                <h1 class="text-2xl font-semibold tracking-tight">Music Recommendation</h1>
                <p class="mt-1 text-sm text-slate-600">Pilih mood dan genre untuk rekomendasi lagu.</p>
            </header>

            <div class="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2">
                <label class="block">
                    <span class="text-sm font-medium text-slate-700">Mood</span>
                    <select id="mood" class="mt-2 w-full rounded-lg bg-white px-3 py-2 text-slate-900 ring-1 ring-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option>Happy</option>
                        <option>Sad</option>
                        <option>Energetic</option>
                        <option>Calm</option>
                        <option>Neutral</option>
                    </select>
                </label>

                <label class="block">
                    <span class="text-sm font-medium text-slate-700">Genre</span>
                    <select id="genre" class="mt-2 w-full rounded-lg bg-white px-3 py-2 text-slate-900 ring-1 ring-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option>Rock</option>
                        <option>Pop</option>
                        <option>Jazz/Blues</option>
                        <option>Classical/Ambient</option>
                        <option>Hip Hop</option>
                        <option>Folk/Country</option>
                        <option>Electronic/Dance</option>
                        <option>Oldies</option>
                        <option>Other</option>
                    </select>
                </label>
            </div>

            <div class="mt-5">
                <button onclick="getRecommendation()" class="inline-flex w-full items-center justify-center rounded-lg bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-slate-50 sm:w-auto">
                    Cari Lagu
                </button>
            </div>

            <div id="result" class="mt-6"></div>
        </section>
    </main>

    <script>
        function showAlert(resultEl, variant, title, message) {
            const styles = {
                info: "bg-slate-50 text-slate-900 ring-slate-200",
                success: "bg-emerald-50 text-emerald-900 ring-emerald-200",
                warning: "bg-amber-50 text-amber-900 ring-amber-200",
                error: "bg-rose-50 text-rose-900 ring-rose-200",
            };

            const cls = styles[variant] ?? styles.info;
            resultEl.innerHTML = `
                <div class="rounded-xl p-4 ring-1 ${cls}">
                    <div class="text-sm font-semibold">${title}</div>
                    <div class="mt-1 text-sm opacity-90">${message}</div>
                </div>
            `;
        }

        function parseArtists(artists) {
            if (Array.isArray(artists)) return artists.join(", ");
            if (typeof artists !== "string") return String(artists ?? "");

            const s = artists.trim();
            if (s.startsWith("[") && s.endsWith("]")) {
                try {
                    const normalized = s.replaceAll("'", '"');
                    const arr = JSON.parse(normalized);
                    if (Array.isArray(arr)) return arr.join(", ");
                } catch (_) {
                    return s;
                }
            }

            return s;
        }

        function renderRecommendations(resultEl, mood, genre, songs) {
            const header = document.createElement("div");
            header.className = "flex flex-col gap-1 sm:flex-row sm:items-end sm:justify-between";

            const title = document.createElement("div");
            title.className = "text-sm font-semibold text-slate-900";
            title.textContent = `Rekomendasi untuk Mood: ${mood} • Genre: ${genre}`;

            const subtitle = document.createElement("div");
            subtitle.className = "text-sm text-slate-600";
            subtitle.textContent = `Ditemukan ${songs.length} lagu`;

            header.appendChild(title);
            header.appendChild(subtitle);

            const grid = document.createElement("div");
            grid.className = "mt-3 grid grid-cols-1 gap-3";

            songs.forEach((song, idx) => {
                const card = document.createElement("div");
                card.className = "rounded-xl bg-white p-4 shadow-sm ring-1 ring-slate-200";

                const top = document.createElement("div");
                top.className = "flex items-start justify-between gap-3";

                const left = document.createElement("div");

                const name = document.createElement("div");
                name.className = "text-base font-semibold leading-snug text-slate-900";
                name.textContent = song?.name ?? "(Tanpa judul)";

                const artists = document.createElement("div");
                artists.className = "mt-1 text-sm text-slate-600";
                artists.textContent = parseArtists(song?.artists);

                left.appendChild(name);
                left.appendChild(artists);

                const right = document.createElement("div");
                right.className = "flex shrink-0 flex-col items-end gap-2";

                const badge = document.createElement("div");
                badge.className = "inline-flex items-center gap-2 rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold text-indigo-700 ring-1 ring-indigo-100";
                const popularity = Number(song?.popularity);
                const popularityText = Number.isFinite(popularity) ? popularity : "-";
                badge.textContent = `Popularity: ${popularityText}`;

                const rank = document.createElement("div");
                rank.className = "text-xs font-medium text-slate-500";
                rank.textContent = `#${idx + 1}`;

                right.appendChild(badge);
                right.appendChild(rank);

                top.appendChild(left);
                top.appendChild(right);

                const tags = document.createElement("div");
                tags.className = "mt-3 flex flex-wrap gap-2";

                const moodTag = document.createElement("span");
                moodTag.className = "rounded-full bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700 ring-1 ring-emerald-100";
                moodTag.textContent = `Mood: ${song?.mood ?? mood}`;

                const genreTag = document.createElement("span");
                genreTag.className = "rounded-full bg-sky-50 px-3 py-1 text-xs font-medium text-sky-700 ring-1 ring-sky-100";
                genreTag.textContent = `Genre: ${song?.genre ?? genre}`;

                tags.appendChild(moodTag);
                tags.appendChild(genreTag);

                card.appendChild(top);
                card.appendChild(tags);
                grid.appendChild(card);
            });

            resultEl.innerHTML = "";
            resultEl.appendChild(header);
            resultEl.appendChild(grid);
        }

        function getRecommendation() {
            let mood = document.getElementById("mood").value;
            let genre = document.getElementById("genre").value;
            const url = `/recommend?mood=${encodeURIComponent(mood)}&genre=${encodeURIComponent(genre)}`;
            const resultEl = document.getElementById("result");
            showAlert(resultEl, "info", "Mencari rekomendasi...", "Mohon tunggu sebentar.");

            fetch(url)
                .then(async (res) => {
                    const data = await res.json();

                    if (!res.ok) {
                        const moodText = data?.mood ?? mood;
                        const genreText = data?.genre ?? genre;
                        const message = data?.message ?? "Tidak ada lagu ditemukan";
                        showAlert(resultEl, "warning", message, `Mood: ${moodText} • Genre: ${genreText}`);
                        return;
                    }

                    if (Array.isArray(data) && data.length === 0) {
                        showAlert(resultEl, "warning", "Tidak ada lagu ditemukan", `Mood: ${mood} • Genre: ${genre}`);
                        return;
                    }

                    if (!Array.isArray(data)) {
                        showAlert(resultEl, "error", "Format data tidak valid", "Server mengirim format yang tidak sesuai.");
                        return;
                    }

                    renderRecommendations(resultEl, mood, genre, data);
                })
                .catch(err => {
                    showAlert(resultEl, "error", "Terjadi kesalahan", `Error: ${err}`);
                });
        }
    </script>
</body>
</html>